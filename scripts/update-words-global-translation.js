// Small helper to generate SQL that updates words_global.translation from the CSV.
// Usage: node scripts/update-words-global-translation.js > /tmp/update_words_global_translation.sql
// Then paste/run the SQL in Supabase SQL editor (or psql).

const fs = require("fs");
const path = require("path");

function escapeSql(str) {
  return str.replace(/'/g, "''");
}

const csvPath = path.join(__dirname, "../seeds/words_global_translations.csv");
const raw = fs.readFileSync(csvPath, "utf8");
const lines = raw
  .split(/\r?\n/)
  .map((l) => l.trim())
  .filter(Boolean);

const tuples = lines.map((line) => {
  const idx = line.indexOf(",");
  if (idx === -1) throw new Error(`Invalid line (no comma): ${line}`);
  const word = line.slice(0, idx).trim();
  const translation = line.slice(idx + 1).trim();
  return `('${escapeSql(word)}','${escapeSql(translation)}')`;
});

const sql = `-- Generated by scripts/update-words-global-translation.js
WITH data(word, translation) AS (
  VALUES
  ${tuples.join(",\n  ")}
)
UPDATE words_global AS w
SET translation = d.translation
FROM data d
WHERE lower(w.word) = lower(d.word);

-- Optional: see how many were updated
WITH data(word) AS (
  VALUES
  ${lines.map((line) => `('${escapeSql(line.slice(0, line.indexOf(","))).trim()}')`).join(",\n  ")}
)
SELECT count(*) AS matched
FROM words_global w
JOIN data d ON lower(w.word) = lower(d.word);
`;

console.log(sql);
